<!DOCTYPE html>
<html>
<head>
  <title>Create and Join Capsules</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="chat.css">
</head>
<body>
  <header>
    <nav class="navbar">
      <ul class="navbar-menu">
        <li class="navbar-item" id="showCapsules"><a href="/home">Home</a></li>
        <li class="navbar-item" id="search"><a href="/search">search</a></li>
        <li class="navbar-item" id="createCapsule"><a href="/createCapsule">create Capsules</a></li>
        <li class="navbar-item" id="changeCapsuleNav"><a href="/changeCapsule">change capsules</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <div class="container">
      <div class="message-container" id="messages"></div>
      <textarea class="textbox" name="message" id="message" cols="60" rows="2" maxlength="1000" placeholder="enter a message ..."></textarea>
      <button id="sendMessage" class="button-27">Send message</button>
    </div>
  </main>
  <script>
    let serverIP = '';
    fetch('/ip')
      .then(response => response.text())
      .then(data => {
        serverIP = data;
        console.log(serverIP);
      })
      .catch(error => {
        console.error('Error fetching server IP:', error);
      });

    const socket = io(`http://${serverIP}:8080`);

    const button = document.getElementById('sendMessage');
    button.addEventListener('click', () => {
    const cookieString = document.cookie;
    const token = getTokenFromCookie(cookieString);
    const message = document.getElementById('message').value;
    if (message.trim() === '') {
      alert('Please enter a message.');
      return;
    }
    document.getElementById('message').value = '';
    socket.emit('sendMessage', { message, token });
  });


    socket.on('message', (message, username) => {
      console.log('Received message:', message);
      console.log('Received it from: ' + username)
      const messagesContainer = document.getElementById('messages');
      const messageElement = document.createElement('div');
      messageElement.classList.add('message');
      messageElement.textContent = username + ': ' + message;
      messagesContainer.appendChild(messageElement);
    });

    function getTokenFromCookie(cookieString) {
      const tokenRegex = /token=([^;]+)/;
      const matches = cookieString.match(tokenRegex);
      if (matches && matches.length > 1) {
        return matches[1];
      } else {
        return null;
      }
    }
  </script>
</body>
</html>
